name: ci-cd

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  REGISTRY: 192.168.215.181:5000
  PROJECT: test-web
  TAG: build-${{ github.run_number }}
  BE_IMAGE: 192.168.215.181:5000/test-web/backend:build-${{ github.run_number }}
  FE_IMAGE: 192.168.215.181:5000/test-web/frontend:build-${{ github.run_number }}
  SWARM_HOST: 192.168.215.181
  SWARM_USER: registry
  STACK_FILE: /opt/stacks/test-web/stack.yml
  STACK_NAME: test-web

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify Node
        run: |
          set -eux
          uname -m
          node -v
          npm -v
          which node
          which npm

  npm_ci:
    runs-on: self-hosted
    needs: [verify]
    strategy:
      matrix:
        app: [backend, frontend]
    steps:
      - uses: actions/checkout@v4
      - name: npm ci (${{ matrix.app }})
        working-directory: ${{ matrix.app }}
        run: |
          set -eux
          npm ci

  eslint:
    runs-on: self-hosted
    needs: [npm_ci]
    strategy:
      matrix:
        app: [backend, frontend]
    steps:
      - uses: actions/checkout@v4
      - name: Lint (${{ matrix.app }})
        working-directory: ${{ matrix.app }}
        run: |
          set -eux
          npm run lint:ci || true

      - name: Upload ESLint report (${{ matrix.app }})
        uses: actions/upload-artifact@v4
        with:
          name: eslint-${{ matrix.app }}
          path: ${{ matrix.app }}/eslint-checkstyle.xml
          if-no-files-found: warn

  gitleaks:
    runs-on: self-hosted
    needs: [verify]
    steps:
      - uses: actions/checkout@v4

      - name: Gitleaks (Docker)
        run: |
          set -eux
          docker run --rm \
            -v "$PWD:/repo" \
            -w /repo \
            zricethezav/gitleaks:latest \
            detect \
              --source . \
              --report-format json \
              --report-path gitleaks-report.json \
              --exit-code 1

      - name: Upload gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          if-no-files-found: warn

  sonar:
    runs-on: self-hosted
    needs: [eslint]
    steps:
      - uses: actions/checkout@v4
        with:
          clean: true

      - name: SonarQube Scan (self-hosted)
        env:
          SONAR_TOKEN: 'squ_3c1ebeecd2253ead3ced5bf34a87297067328c54'
          SONAR_HOST_URL: 'http://192.168.215.180:9000'
          SONAR_SCANNER_OPTS: "-Dsonar.scanner.forceUseClassicScanner=true"
        run: |
#          sonar-scanner \
#            -Dsonar.projectKey=node-react-crud \
#            -Dsonar.sources=backend,frontend \
#            -Dsonar.host.url=$SONAR_HOST_URL \
#            -Dsonar.token=$SONAR_TOKEN
        
  build_images:
    runs-on: self-hosted
    needs: [sonar]
    strategy:
      matrix:
        app: [backend, frontend]
        include:
          - app: backend
            image: 192.168.215.181:5000/test-web/backend:build-${{ github.run_number }}
            context: backend
          - app: frontend
            image: 192.168.215.181:5000/test-web/frontend:build-${{ github.run_number }}
            context: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Docker login to private registry
        run: |
          set -eux
          echo "${{ secrets.REGISTRY_USERNAME }}" | docker login 192.168.215.181:5000 \
          -u "${{ secrets.REGISTRY_PASSWORD }}" \
          --password-stdin
          
      - name: Build image (${{ matrix.app }})
        run: |
          set -euxo pipefail
          docker build -t "${{ matrix.image }}" "${{ matrix.context }}"

  trivy_image:
    runs-on: self-hosted
    needs: [build_images]
    strategy:
      matrix:
        app: [backend, frontend]
        include:
          - app: backend
            image: 192.168.215.181:5000/test-web/backend:build-${{ github.run_number }}
            report: trivy-reports/backend-image-report.txt
          - app: frontend
            image: 192.168.215.181:5000/test-web/frontend:build-${{ github.run_number }}
            report: trivy-reports/frontend-image-report.txt
    steps:
      - uses: actions/checkout@v4

      - name: Trivy image scan (${{ matrix.app }})
        env:
          TRIVY_CACHE_DIR: ${{ runner.temp }}/trivy-cache
        run: |
          set -euxo pipefail
          mkdir -p trivy-reports
          trivy image \
            --cache-dir "$TRIVY_CACHE_DIR" \
            --scanners vuln \
            --severity HIGH,CRITICAL \
            --format table \
            -o "${{ matrix.report }}" \
            "${{ matrix.image }}"

      - name: Upload trivy image report (${{ matrix.app }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-${{ matrix.app }}
          path: ${{ matrix.report }}
          if-no-files-found: warn

  push_images:
    runs-on: self-hosted
    needs: [trivy_image]
    strategy:
      matrix:
        app: [backend, frontend]
        include:
          - app: backend
            image: 192.168.215.181:5000/test-web/backend:build-${{ github.run_number }}
          - app: frontend
            image: 192.168.215.181:5000/test-web/frontend:build-${{ github.run_number }}
    steps:
      - name: Docker login to private registry
        run: |
          set -eux
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login $REGISTRY -u $REGISTRY_USERNAME --password-stdin

      - name: Push image (${{ matrix.app }})
        run: |
          set -euxo pipefail
          docker push "${{ matrix.image }}"

  deploy_swarm:
    runs-on: self-hosted
    needs: [push_images]
    steps:
      - name: Setup SSH key
        run: |
          set -eux
          mkdir -p ~/.ssh
          echo "${{ secrets.SWARM_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "$SWARM_HOST" >> ~/.ssh/known_hosts

      - name: Deploy to Swarm (remote)
        run: |
          set -euxo pipefail
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes $SWARM_USER@$SWARM_HOST << EOF
            set -euxo pipefail
            docker node ls
            export IMAGE_TAG="${TAG}"
            docker stack deploy -c "${STACK_FILE}" "${STACK_NAME}"
            docker stack services "${STACK_NAME}"
          EOF
